<!DOCTYPE html>
<html>
    <head>
        <title>Measure XHR Request time...</title>
		<style>
		table, th, td {
			width:auto;
			min-width:200px;
			border: 4px solid;
			border-collapse: collapse;
			border-color:green;
		}
		th {
			font-family:sans-serif;
			font-size:20pt;
			color:white;
			background-color:navy;
		}
		th, td {
			padding: 5px;
		}
		td {
			font-family:sans-serif;
			font-size:14pt;
			color:navy;
			background-color:white;
			vertical-align:middle;
		}
		td.result{
			text-align:center;
		}
		div.averageBitrate{
			padding-left: auto;
			padding-right: auto;
			margin-left: auto;
			margin-right: auto;
			margin-top: 50 px;
			font-family:sans-serif;
			font-size:18pt;
			font-weight: bold;
			color:navy;
			background-color:white;
			width:500px;
		}
	</style>
    </head>
    <body onload="fillRequestTable();startXHRRequestSend()">
		<script>
			var reqCount = 0;
			var dateStart = null;
			var dateEnd = null;
			var performanceAvailable = true;
			
			var req = ['http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Manifest.xml',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=0).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=20000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=40000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=80000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=100000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=120000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=140000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=160000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=180000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=200000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=220000000).mp4',
					   'http://tv-has.orange-labs.fr/mercury/tests/video/BBB/Fragments(video=240000000).mp4'];
			var bandwithTab =[];
			
			function isPerformanceAvailable() {
				if(window.performance === undefined){
					performanceAvailable = false;
				}
			}
			
			function startXHRRequestSend() {
				var myReq = new XMLHttpRequest();
				myReq.open('GET', req[reqCount], true);
				myReq.onload = function(e) {
					if(performanceAvailable){
						window.performance.mark('mark_end_xhr');
						window.performance.measure(req[reqCount], 'mark_start_xhr', 'mark_end_xhr');
					}
					else {
						dateEnd = new Date().getTime();
					}
					showReqDuration(e.loaded);
					reqCount++;
					if(performanceAvailable){
						window.performance.clearMeasures();
						window.performance.clearMarks();
					}
					else {
						dateStart = null;
						dateEnd = null;
					}
					if(reqCount<req.length)
						startXHRRequestSend();
					else{
						defineAverageBitrate();
					}
				}					
				myReq.onError = function(e){
					document.getElementById('averageBitrate').innerHTML = '<p class=\"averageBitrate\">Une erreur ' + e.target.status + ' s\'est produite au cours de la r√©ception du document.</p>';
				}
				isPerformanceAvailable();
				if(performanceAvailable){
					window.performance.mark('mark_start_xhr');
				}
				else{
					dateStart = new Date().getTime();
				}
				myReq.send();
			}
			
			function defineAverageBitrate(){
		        var nbBitrate = bandwithTab.length;
				var somme = 0;
				for(var i=0; i<nbBitrate; i++){
					somme += bandwithTab[i];
				}
				document.getElementById('averageBitrate').innerHTML = '<p class=\"averageBitrate\">Average Bitrate : '+Math.round((somme/nbBitrate)).toLocaleString() + ' kbps</p>';
			}
			
			function showReqDuration(resultLength){
				var requestResu = {name:null,duration:null};
				
				if(performanceAvailable)
				{
					var items = window.performance.getEntriesByType('measure');
					requestResu = items[0];					
				}
				else {
					requestResu.duration = dateEnd - dateStart;
					requestResu.name = req[reqCount];
				}
				var bitrate = Math.round(((resultLength*8)/(requestResu.duration)));
				bandwithTab.push(bitrate);
				document.getElementById(requestResu.name+'.bitrate').innerHTML = bitrate.toLocaleString() + ' kbps';
				document.getElementById(requestResu.name+'.length').innerHTML = resultLength;
				document.getElementById(requestResu.name).innerHTML = requestResu.duration.toFixed(3) + ' ms';
			}
			function fillRequestTable(){
				var str='<table><tr><th>Request</th><th>duration</th><th>content-length</th><th>bitrate</th></tr>';
				for (var i=0; i<req.length; i++) {
				  str += '<tr><td>'+req[i]+'</td><td id=\"'+req[i]+'\" class=\"result\"></td><td id=\"'+req[i]+'.length\" class=\"result\"></td><td id=\"'+req[i]+'.bitrate\" class=\"result\"></td></tr>';
				}
				str += '</table>';
				document.getElementById('RequestTab').innerHTML = str;
			}
		</script><div id="RequestTab"></div>
		<div id="averageBitrate" class="averageBitrate"></div>
	</body>
</html>